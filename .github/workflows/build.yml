name: Build Multi-Architecture Binaries

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°ä¸»åˆ†æ”¯ã€æ ‡ç­¾æ¨é€ã€æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ main, master ]
    tags: [ '*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Binaries
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          # AMD64 å¾®æ¶æ„å˜ä½“
          - goos: linux
            goarch: amd64
            goamd64: v1
            name: go-mmproxy-linux-amd64-v1
          - goos: linux
            goarch: amd64
            goamd64: v2
            name: go-mmproxy-linux-amd64-v2
          - goos: linux
            goarch: amd64
            goamd64: v3
            name: go-mmproxy-linux-amd64-v3
          - goos: linux
            goarch: amd64
            goamd64: v4
            name: go-mmproxy-linux-amd64-v4
          
          # ARM æ¶æ„å˜ä½“
          - goos: linux
            goarch: arm64
            name: go-mmproxy-linux-arm64
          - goos: linux
            goarch: arm
            goarm: 5
            name: go-mmproxy-linux-armv5
          - goos: linux
            goarch: arm
            goarm: 6
            name: go-mmproxy-linux-armv6
          - goos: linux
            goarch: arm
            goarm: 7
            name: go-mmproxy-linux-armv7
          
          # å…¶ä»–æ¶æ„
          - goos: linux
            goarch: 386
            name: go-mmproxy-linux-386
          - goos: linux
            goarch: ppc64
            name: go-mmproxy-linux-ppc64
          - goos: linux
            goarch: ppc64le
            name: go-mmproxy-linux-ppc64le
          - goos: linux
            goarch: mips
            name: go-mmproxy-linux-mips
          - goos: linux
            goarch: mipsle
            name: go-mmproxy-linux-mipsle
          - goos: linux
            goarch: mips64
            name: go-mmproxy-linux-mips64
          - goos: linux
            goarch: mips64le
            name: go-mmproxy-linux-mips64le
          - goos: linux
            goarch: riscv64
            name: go-mmproxy-linux-riscv64
          - goos: linux
            goarch: s390x
            name: go-mmproxy-linux-s390x
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿ git describe å·¥ä½œ
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25.1'  # ä½¿ç”¨è¾ƒæ–°çš„ Go ç‰ˆæœ¬ä»¥æ”¯æŒæ‰€æœ‰æ¶æ„
    
    - name: Get version and build info
      id: version
      run: |
        # è·å–ç‰ˆæœ¬ä¿¡æ¯
        VERSION=$(git describe --tags 2>/dev/null || echo "unknown")
        BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        
        echo "Version: $VERSION"
        echo "Build Date: $BUILD_DATE"
    
    - name: Create build directory
      run: mkdir -p build
    
    - name: Build binary
      env:
        CGO_ENABLED: 0
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        GOAMD64: ${{ matrix.goamd64 }}
        GOARM: ${{ matrix.goarm }}
      run: |
        # æ„å»º LDFLAGS
        LDFLAGS="-s -w -X main.version=${{ steps.version.outputs.version }} -X main.buildDate=${{ steps.version.outputs.build_date }}"
        
        echo "Building ${{ matrix.goos }}/${{ matrix.goarch }} -> ${{ matrix.name }}"
        
        # æ˜¾ç¤ºç¯å¢ƒå˜é‡ï¼ˆè°ƒè¯•ç”¨ï¼‰
        echo "GOOS: $GOOS"
        echo "GOARCH: $GOARCH"
        if [ -n "$GOAMD64" ]; then echo "GOAMD64: $GOAMD64"; fi
        if [ -n "$GOARM" ]; then echo "GOARM: $GOARM"; fi
        
        # æ‰§è¡Œæ„å»º
        go build -ldflags="$LDFLAGS" -o "build/${{ matrix.name }}"
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
        if [ -f "build/${{ matrix.name }}" ]; then
          echo "âœ… Successfully built ${{ matrix.name }}"
          ls -la "build/${{ matrix.name }}"
        else
          echo "âŒ Failed to build ${{ matrix.name }}"
          exit 1
        fi
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.name }}
        path: build/${{ matrix.name }}
        retention-days: 30
  
  # æ±‡æ€»æ‰€æœ‰æ„å»ºç»“æœ
  collect-artifacts:
    name: Collect All Artifacts
    runs-on: ubuntu-latest
    needs: build
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts
    
    - name: Organize artifacts
      run: |
        mkdir -p build
        find artifacts -name 'go-mmproxy-*' -type f -exec cp {} build/ \;
        
        echo "ğŸ“¦ æ„å»ºå®Œæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la build/
        
        echo ""
        echo "ğŸ“‹ å„ç‰ˆæœ¬è¯´æ˜:"
        echo "- amd64-v1: å…¼å®¹æ‰€æœ‰ x86-64 CPU (æœ€åŸºæœ¬æŒ‡ä»¤é›†)"
        echo "- amd64-v2: éœ€è¦ SSE4.2, POPCNT ç­‰æŒ‡ä»¤ (2009å¹´åCPU)"
        echo "- amd64-v3: éœ€è¦ AVX, AVX2, BMI1, BMI2 ç­‰æŒ‡ä»¤ (2013å¹´åCPU)"
        echo "- amd64-v4: éœ€è¦ AVX512F, AVX512BW, AVX512VL ç­‰æŒ‡ä»¤ (è¾ƒæ–°CPU)"
        echo ""
        echo "ğŸ—ï¸ å…¶ä»–æ¶æ„: arm64, armv5/6/7, 386, ppc64(le), mips(le), riscv64, s390x"
    
    - name: Upload combined artifacts
      uses: actions/upload-artifact@v3
      with:
        name: go-mmproxy-all-binaries
        path: build/
        retention-days: 90
  
  # å¦‚æœæ˜¯æ ‡ç­¾æ¨é€ï¼Œåˆ›å»º GitHub Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: collect-artifacts
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all binaries
      uses: actions/download-artifact@v3
      with:
        name: go-mmproxy-all-binaries
        path: build
    

    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ github.ref_name }}
        files: |
          build/*
        body: |
          Latest build for the current [commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}