# GitHub Actions 工作流说明

本目录包含了 go-mmproxy 项目的 GitHub Actions 自动化构建配置，提供与本地 `build.ps1` 脚本相同的功能。

## 工作流文件

### 1. `build.yml` - 完整多架构构建

**触发条件:**
- 推送到 `main`/`master` 分支
- 推送标签 (如 `v1.0.0`)
- Pull Request 到 `main`/`master` 分支
- 手动触发

**构建架构:**
- **AMD64 微架构变体:** v1, v2, v3, v4
- **ARM:** arm64, armv5, armv6, armv7
- **其他:** 386, ppc64, ppc64le, mips, mipsle, mips64, mips64le, riscv64, s390x

**功能特性:**
- 🏗️ 并行构建所有架构
- 📦 自动上传构建产物
- 🏷️ 标签推送时自动创建 GitHub Release
- ✅ 包含 SHA256 校验和
- 📋 详细的架构说明文档

### 2. `test.yml` - 快速测试和构建

**触发条件:**
- 推送到 `main`/`master` 分支
- Pull Request
- 手动触发

**功能特性:**
- 🧪 运行单元测试
- 🔍 代码质量检查 (`go vet`, `go fmt`)
- ⚡ 快速构建 (仅 amd64)
- 📦 上传测试版本 (保留7天)

## 使用说明

### 自动触发

1. **开发测试:** 创建 Pull Request 时会自动运行测试工作流
2. **完整构建:** 合并到主分支时会运行完整的多架构构建
3. **发布版本:** 推送标签时会自动创建 GitHub Release

### 手动触发

在 GitHub 仓库页面:
1. 点击 "Actions" 标签
2. 选择要运行的工作流
3. 点击 "Run workflow" 按钮

### 下载构建产物

**从 Actions 页面:**
1. 进入 "Actions" 标签
2. 选择对应的工作流运行
3. 在 "Artifacts" 部分下载所需文件

**从 Releases 页面:**
- 标签推送会自动在 "Releases" 页面创建发布版本
- 包含所有架构的二进制文件和校验和

## 架构选择指南

### AMD64 微架构版本

| 版本 | 适用 CPU | 指令集特性 | 推荐使用场景 |
|------|----------|------------|-------------|
| v1 | 所有 x86-64 | 基本指令集 | 最大兼容性 |
| v2 | 2009年后 | SSE4.2, POPCNT | 现代服务器 |
| v3 | 2013年后 | AVX, AVX2, BMI1/2 | 高性能计算 |
| v4 | 较新 CPU | AVX512F/BW/VL | 最新硬件 |

### 其他架构

- **arm64:** 现代 ARM 服务器 (如 AWS Graviton)
- **armv7:** 树莓派 4 等设备
- **armv6:** 树莓派 Zero 等老设备
- **armv5:** 非常老的 ARM 设备
- **mips/mipsle:** 路由器等嵌入式设备
- **riscv64:** RISC-V 架构设备

## 与本地构建脚本的对比

| 特性 | build.ps1 | GitHub Actions |
|------|-----------|----------------|
| 多架构支持 | ✅ | ✅ |
| AMD64 微架构 | ✅ | ✅ |
| 版本信息 | ✅ | ✅ |
| 并行构建 | ❌ | ✅ |
| 自动发布 | ❌ | ✅ |
| 校验和生成 | ❌ | ✅ |
| 测试集成 | ❌ | ✅ |

## 环境变量说明

构建过程中使用的关键环境变量:

- `CGO_ENABLED=0`: 禁用 CGO，生成静态链接二进制
- `GOOS`: 目标操作系统
- `GOARCH`: 目标架构
- `GOAMD64`: AMD64 微架构版本 (v1-v4)
- `GOARM`: ARM 版本 (5, 6, 7)

## 故障排除

### 构建失败
1. 检查 Go 版本兼容性
2. 确认代码语法正确
3. 查看具体的错误日志

### 找不到构建产物
1. 确认工作流运行成功
2. 检查 "Artifacts" 部分
3. 注意产物保留期限

### 版本信息不正确
1. 确保仓库有标签
2. 检查 `fetch-depth: 0` 配置
3. 验证 git 历史完整性

## 自定义配置

如需修改构建配置:

1. **添加新架构:** 在 `build.yml` 的 `matrix.include` 中添加新条目
2. **修改 Go 版本:** 更新 `go-version` 参数
3. **调整保留期:** 修改 `retention-days` 值
4. **自定义 LDFLAGS:** 修改构建步骤中的 `LDFLAGS` 变量

## 许可证

本配置文件遵循与 go-mmproxy 项目相同的 BSD-3-Clause 许可证。